// Module included in the following assemblies:
// * serverless-logic/serverless-logic-managing-events/serverless-logic-configuring-asyncapi

:_mod-docs-content-type: CONCEPT
[id="serverless-logic-event-correlation_{context}"]
= Event correlation 

Event correlation in large event-driven applications, enabling the matching of one or more events with a specific workflow instance. Instead of relying on the internal identifier `processInstanceId`, you can use any external domain identifier for correlation. This approach allows you to use domain-specific information to define consumed events and match them with the appropriate workflow instance.

A correlation definition includes one or more attributes associated with an event and the corresponding workflow. In the Serverless Workflow specification, the `correlation` property defines the possible correlations for a given event. Each element must contain a `contextAttributeName` property, which matches an attribute from an event.

Optionally, you can set the `contextAttributeValue` property. This property matches the value for the respective attribute defined in the `contextAttributeName` property for the consumed events in a workflow.

[NOTE]
====
The incoming events consumed by the engine must include the correlation attributes. You must set these attributes in the definition as extension context attributes. The correlation attributes comply with the link:https://cloudevents.io/[cloudEvent] format, meaning they are not part of the event payload.
====

Here is an example to illustrate how you can define correlation in a Serverless Workflow specification:
[source,json]
----
{
  "correlation": [
    {
      "contextAttributeName": "orderId",
      "contextAttributeValue": "12345"
    }
  ],
  "functions": [
    {
      "name": "consumeEvent",
      "type": "asyncapi",
      "operation": "asyncAPI.yaml#consumeWait"
    }
  ],
  "states": [
    {
      "name": "waitForEvent",
      "type": "operation",
      "actions": [
        {
          "functionRef": "consumeEvent"
        }
      ]
    }
  ]
}
----

To create a new workflow instance using an event, you must declare the event in the workflow definition file, including correlation attributes in the event definition section.

When an event is consumed, the engine extracts the correlation attributes and associates them with the created workflow instance. A start event does not trigger a correlation evaluation. Instead, it sets the correlation attributes and values. These attributes and values are then evaluated against other incoming events that may trigger the given instance. When a non-start event is consumed and correlation attributes are evaluated, the engine continues executing the matched instances (if any).

.Example of event correlation in a workflow
To use event correlation in a workflow, you must declare the events and their correlation attributes in the workflow definition file.
[source,json]
----
{
  "events": [
    {
      "name": "newAccountEvent",
      "source": "",
      "type": "newAccountEventType",
      "correlation": [
        {
          "contextAttributeName": "userid"
        }
      ]
    },
    {
      "name": "validateAccountEmailEvent",
      "source": "workflow",
      "type": "validateAccountEmail"
    },
    {
      "name": "validatedAccountEmailEvent",
      "source": "workflow",
      "type": "validatedAccountEmail",
      "correlation": [
        {
          "contextAttributeName": "userid"
        }
      ]
    },
    {
      "name": "activateAccountEvent",
      "source": "workflow",
      "type": "activateAccount"
    },
    {
      "name": "activatedAccountEvent",
      "source": "workflow",
      "type": "activatedAccount",
      "correlation": [
        {
          "contextAttributeName": "userid"
        }
      ]
    }
  ]
}
----

You can create a workflow by consuming events defined in the `New User Account Request` event state. This state references the `newAccountEvent` event, which includes a correlation definition for the userid attribute.
[source,json]
----
{
  "name": "New User Account Request",
  "type": "event",
  "onEvents": [
    {
      "eventRefs": [
        "newAccountEvent"
      ]
    }
  ],
  "transition": "Validate User Email"
}
----

When the workflow consumes an event of type `newAccountEventType`, it creates a workflow instance. Subsequent events consumed by the same workflow must contain the same correlation attribute and value, such as `userid` with value `12345`. This ensures that the workflow instance can be matched and continued.

.Example of an incoming start event
[source,json]
----
{
  "specversion": "0.3",
  "id": "1d174d25-46ac-4785-bc76-457c2d37d2fe",
  "source": "",
  "type": "newAccountEventType",
  "time": "2022-07-25T16:30:35.461988261-03:00",
  "userid": "12345",
  "data": {
    "email": "test@test.com",
    "userId": "12345"
  }
}
----

.Example of callback state and event production
When the workflow reaches the callback state, it publishes an event of type `validateAccountEmailEvent` and waits for an event of type `validatedAccountEmailEvent`.
[source,json]
----
{
  "name": "Validate User Email",
  "type": "callback",
  "action": {
    "name": "publish validate event",
    "eventRef": {
      "triggerEventRef": "validateAccountEmailEvent"
    }
  },
  "eventRef": "validatedAccountEmailEvent",
  "transition": "Activate User Account"
}
----

.Example of produced callback state event
[source,json]
----
{
  "id": "7640a0af-b7fb-4d94-9d9d-3aa1ace60e79",
  "source": "/process/correlation",
  "type": "validateAccountEmail",
  "time": "2022-07-25T16:22:53.735128049-03:00",
  "data": {
    "email": "test@test.com",
    "userId": "12345"
  },
  "specversion": "1.0",
  "kogitoprocinstanceid": "69019826-daef-4fb4-880b-c1658c4e49bc",
  "kogitoprocid": "correlation",
  "kogitoprocversion": "1.0",
  "kogitousertaskist": "1",
  "kogitoproctype": "SW",
  "userid": "12345"
}
----

.Example of consumed callback state event
All consumed events must contain the same correlation attributes. The following example shows a consumed event with the same user`id and value `12345`:
[source,json]
----
{
  "specversion": "1.0",
  "id": "953f07a7-aea8-4956-8775-85ab59366fe6",
  "source": "",
  "type": "validatedAccountEmail",
  "time": "2022-07-25T16:29:27.320408379-03:00",
  "userid": "12345",
  "data": null
}
----