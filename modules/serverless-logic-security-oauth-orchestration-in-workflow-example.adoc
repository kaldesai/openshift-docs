// Module included in the following assemblies:
// * serverless-logic/serverless-logic-managing-security


:_mod-docs-content-type: REFERNECE
[id="serverless-logic-security-oauth-orchestration-in-workflow-example_{context}"]
= Example of OAuth 2.0 orchestration in a workflow

The `serverless-workflow-oauth2-orchestration-quarkus` example application demonstrates a complete implementation of a workflow that orchestrates a secured third-party service. This example application implements a real-world workflow for currency exchange calculations, orchestrating an OAuth 2.0 secured REST service provided by Acme Financial Services. The application implements a currency exchange workflow that interacts with an OAuth 2.0 secured REST service provided by Acme Financial Services.

Suppose you have a set of applications that require accurate and up-to-date currency exchange rates. Rather than exposing a third-party service like Acme Financial Services directly to your applications, you can:

* Design a workflow that interacts with Acme.
* Securely authenticate using OAuth 2.0 credentials.
* Perform business validations and domain-specific optimizations.
* Abstract the service provider to reduce future vendor lock-in.

The `serverless-workflow-oauth2-orchestration-quarkus` application contains three main services:

* `currency-exchange-workflow`: Implements the currency exchange workflow logic.
* `acme-financial-service`: Provides currency exchange rates via a REST API.
* `acme-oauth2-server`(Keycloak):	Secures the REST services through OAuth 2.0 authentication.

The following `currency-exchange-workflow.sw.json` example file shows the specification of the `currency-exchange-workflow`:

[source,json]
----
{
  "id": "currency_exchange_workflow",
  "version": "1.0",
  "name": "Currency Exchange SW",
  "dataInputSchema": "currency-exchange-workflow-schema.json",
  "start": "ValidateInputs",
  "functions": [
    {
      "name": "validateInputs",
      "type": "custom",
      "operation": "service:org.kie.kogito.examples.ExchangeWorkflowHelper::validateInputs"
    },
    {
      "name": "getExchangeRate",
      "type": "rest",
      "operation": "specs/acme-financial-service.yml#exchangeRate"
    },
    {
      "name": "calculateExchange",
      "type": "expression",
      "operation": "${ { calculateExchangeResult: .amount * .exchangeRate } }"
    }
  ],
  "errors": [
    {
      "name": "service_error",
      "code": "java.lang.Exception"
    }
  ],
  "states": [
    {
      "name": "ValidateInputs", <1>
      "type": "operation",
      "actions": [
        {
          "name": "validateInputsAction",
          "functionRef": {
            "refName": "validateInputs",
            "arguments": {
              "currencyFrom": "${ .currencyFrom }",
              "currencyTo": "${ .currencyTo }",
              "amount": "${ .amount }",
              "exchangeDate": "${ .exchangeDate }"
            }
          }
        }
      ],
      "transition": "CheckValidation"
    },
    {
      "name": "CheckValidation", <2>
      "type": "switch",
      "dataConditions": [
        {
          "condition": "${ .executionStatus == \"ERROR\" }",
          "end": true
        }
      ],
      "defaultCondition": {
        "transition": "GetExchangeRate"
      }
    },
    {
      "name": "GetExchangeRate", <3>
      "type": "operation",
      "actions": [
        {
          "name": "getExchangeRateAction",
          "functionRef": {
            "refName": "getExchangeRate",
            "arguments": {
              "currencyFrom": "${ .currencyFrom }",
              "currencyTo": "${ .currencyTo }",
              "exchangeDate": "${ .exchangeDate }"
            }
          },
          "actionDataFilter": {
            "results": "${ {exchangeRate: .rate} }"
          }
        }
      ],
      "transition": "CalculateExchange",
      "onErrors": [
        {
          "errorRef": "service_error",
          "transition": "EndWithError"
        }
      ]
    },
    {
      "name": "CalculateExchange", <4>
      "type": "operation",
      "actions": [
        {
          "name": "calculateExchangeAction",
          "functionRef": {
            "refName": "calculateExchange"
          },
          "actionDataFilter": {
            "results": "${ {result: .calculateExchangeResult} }"
          }
        }
      ],
      "transition": "EndSuccessful"
    },
    {
      "name": "EndWithError", <5>
      "type": "inject",
      "data": {
        "executionStatus": "ERROR",
        "executionStatusMessage": "Execution failed: The acme-financial-service invocation has failed, check that the service is running and that you have configured the OAuth2 client properly"
      },
      "end": true
    },
    {
      "name": "EndSuccessful", <6>
      "type": "inject",
      "data": {
        "executionStatus": "OK",
        "executionStatusMessage": "Execution successful"
      },
      "end": true
    }
  ]
}
----

<1> `ValidateInputs` state executes the `validateInputs` function to validate the input data.
<2> `CheckValidation` state determines the next state to go by evaluating the validation results.
<3> `GetExchangeRate` state executes the `getExchangeRate` function to retrieve the exchange rate from the remote server.
<4> `CalculateExchange` state executes the `calculateExchange` function to calculate the currency exchange.
<5> `EndWithError` state finalizes the workflow with an `ERROR`.
<6> `EndSuccessful` state finalizes the workflow with successful `OK` status.

The validation logic is implemented using a custom Java `ExchangeWorkflowHelper` class as follows:

.Example of `ExchangeWorkflowHelper.java` file

[source,java]
----
package org.kie.kogito.examples;

import javax.enterprise.context.ApplicationScoped;

@ApplicationScoped
public class ExchangeWorkflowHelper {

    public ValidationResult validateInputs(String currencyFrom,
                                           String currencyTo,
                                           double amount,
                                           String exchangeDate) {
        // Implement your custom Java processing here and return
        // a Java POJO to the Serverless Workflow.
        if (!good) {
            return new ValidationResult("ERROR", "Not good!");
        }
        return new ValidationResult();
    }

    public static class ValidationResult {
        private String executionStatus;
        private String executionStatusMessage;
        // getters, setters, etc.
    }
}
----

To access the `acme-financial-service` REST service in `currency-exchange-workflow` application, a workflow function such as `getExchangeRate` is used.

.Example of `getExchangeRate` function definition
[source,json]
----
{
  "name": "getExchangeRate",
  "type": "rest",
  "operation": "specs/acme-financial-service.yml#exchangeRate"
}
----

In order to filter the information, which must be returned to the currency-exchange-workflow, an `actionDataFilter` is used as follows:

.Example of `actionDataFilter` to pass the `getExchangeRate` results
[source,json]
----
"actionDataFilter": {
  "results": "${ {exchangeRate: .rate} }"
}
----

To calculate the currency exchange rates in `currency-exchange-workflow`, a function named `calculateExchange` is used as follows:

.Example of `calculateExchange` function definition
[source,json]
----
{
  "name": "calculateExchange",
  "type": "expression",
  "operation": "${ { calculateExchangeResult: .amount * .exchangeRate } }"
}
----

Similar to `getExchangeRate` to filter the information, which must be returned to the `currency-exchange-workflow`, an `actionDataFilter` is used:

.Example of `actionDataFilter` to pass the `calculateExchange` results
[source,json]
----
 "actionDataFilter": {
    "results": "${ {result: .calculateExchangeResult} }" 
  }
----

The Acme REST service is secured using an OAuth 2.0 `clientCredentials` flow as shown in the following example:

.Example of `acme-financial-service.yml` OpenAPI specification
[source,yaml]
----
openapi: 3.0.3
info:
  title: Acme Financial Service API
  version: 1.0.1
paths:
  /financial-service/exchange-rate: <1>
    get:
      tags:
        - Acme Financial Resource
      operationId: exchangeRate
      parameters: <2>
        - name: currencyFrom
          in: query
          schema:
            type: string
        - name: currencyTo
          in: query
          schema:
            type: string
        - name: exchangeDate
          in: query
          schema:
            type: string
      responses: <3>
        "200":
          description: OK
          content: <4>
            application/json:
              schema:
                $ref: '#/components/schemas/ExchangeRateResult'
      security:
        - acme-financial-oauth: [ ] <5>
components:
  schemas:
    ExchangeRateResult: <6>
      type: object
      properties:
        rate:
          format: double
          type: number
  securitySchemes:
    acme-financial-oauth: <7>
      type: oauth2 <8>
      flows:
        clientCredentials: <9>
          authorizationUrl: http://localhost:8281/auth/realms/kogito/protocol/openid-connect/auth
          tokenUrl: http://localhost:8281/auth/realms/kogito/protocol/openid-connect/token
          scopes: { }
----

<1> REST path to access the `exchangeRate` operation in the remote server.
<2> Parameter of the `exchangeRate` operation.
<3> Responses of the `exchangeRate` operation.
<4> Response type and data exchange format.
<5> Specifies that the `exchangeRate` operation is secured using the `acme-financial-oauth` security scheme.
<6> Response type specification.
<7> Specification of the `acme-financial-oauth` security scheme.
<8> Security scheme type.
<9> Authentication flow and related information.